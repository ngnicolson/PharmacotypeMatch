---
title: "Pharmacotyping_Outcomes_Manuscript_NGN"
author: "Norman Nicolson"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 12)
```

```{r load-packages, message=FALSE }

library(ComplexHeatmap)
library(ggplot2)
library(survminer)
library(survival)
library(corrgram)
library(tidyverse)
library(DescTools)
library(viridis)


```

Build dummy/simulated pharmacotyping grid with all levels; chemo agents in columns 1:n-1, last column "case.ID".

This is the format the later regimenMatch algorithm expects, either from sim grid or actual pharmacotype data

```{r sim-grid}
###################### sim grid maker
buildSimGrid<- function(sensitivityLevels, drugList){
pharmacotypingGenericGrid <- data.frame(case.ID = 1:(length(sensitivityLevels))^(length(drugList)))
for (i in 1:length(drugList)){
  pharmacotypingGenericGrid[,1+i] <- factor(rep(rep(sensitivityLevels, each = (length(sensitivityLevels))^(length(drugList)-i)) , times = (length(sensitivityLevels))^(i-1)),
                                          levels = rev(sensitivityLevels))
}
colnames(pharmacotypingGenericGrid)<-c("case.ID", drugList)
pharmacotypingGenericGrid<-pharmacotypingGenericGrid[,c(drugList, "case.ID")]
pharmacotypingGenericGrid
}

########
## run buildSimGrid for pharmacotype grid as constructed in our group
pharmacotypedCasesSim<- buildSimGrid(sensitivityLevels = c("Sensitive", "Intermediate", "Resistant"), drugList = c("FU", "SN38", "OX",  "GEM","PAC"))

```


The pharmacotyping algorithm regimenMatch takes as input a data frame of cases (rows) by drugs (cols), or Sim grid generated above, with discrete levels of sensitivity. Each row also must end with case.ID. 

Builds all possible permutations of provided drugs in the PT panel, and key of which drugs are in which regimens. Option (recommended) to include tiers of combinations if not all are allowed: ranked preferred and/or prohibited regimens. If no list is provided will use all possible combinations of drugs which may not be realistic in some settings. 

Matches cases to regimens by minimizing Manhattan distance metric from idealized case for each regimen to actual pharmacotyped cases, breaking ties by rankings provided (otherwise will tend to prefer more-drug regimen over monotherapy or fewer-drugs if no rankings provided). 

Returns list of summary table of matches at [[1]], original pharmacotype grid annotated with matches at [[2]], all possible drug combinations at [[3]], heatmap object at [[4]]. To print heatmap to visualize pharmacotyping results, call [[4]] or [["heatmapFigure"]]

```{r regimen-match-algorithm}

regimenMatch<- function(pharmacotypedCases, preferredRegimens = NULL, prohibitedRegimens = NULL, sensitivityLevels = c("Sensitive", "Intermediate", "Resistant"), usePermutedCombos = TRUE){

#get list of agents from provided grid  
chemoAgentsList <- colnames(pharmacotypedCases[,1:(ncol(pharmacotypedCases)-1)])

#compute all possible combinations of agents
chemoCombinations <- chemoAgentsList
for (i in 2:length(chemoAgentsList)) {
chemoCombo <- combn(chemoAgentsList, i)
chemoCombinations <- c(chemoCombinations, apply(chemoCombo, 2, paste0, collapse = "-"))
}

allRegimens <- chemoCombinations
rm(chemoCombo, chemoCombinations, i)

## get list of computed regimens that aren't in provided prohibited list or preferred list
## note will favor multi-agent over single-agent by default, including higher-multi-agent regimens
leftoverRegimens <- rev(allRegimens[!allRegimens %in% c(preferredRegimens, prohibitedRegimens) ])
if (!usePermutedCombos) {leftoverRegimens = NULL}

allRegimensPrioritized <- unique(c(preferredRegimens, leftoverRegimens, "Pan-resistant"))

#build key of which drugs are in which combos, including null/pan-resistant "combo"
chemoCombinationsKey <- data.frame(combo = allRegimensPrioritized)
for (i in 1:length(chemoAgentsList)){
chemoCombinationsKey[,1+i] <- ifelse(grepl(chemoAgentsList[[i]], chemoCombinationsKey$combo), 1 , 0)
}
#set row and column names, drop "combo" column once it's used to set rownames
colnames(chemoCombinationsKey) <- c("combo", chemoAgentsList)
rownames(chemoCombinationsKey) <- chemoCombinationsKey$combo
chemoCombinationsKey <- chemoCombinationsKey[,chemoAgentsList]
#put all zeros for pan resistant
chemoCombinationsKey["Pan-resistant",] <- rep(0, ncol(chemoCombinationsKey))


#make new empty column of matches per each case in pharmacotyping grid
pharmacotypedCases$matchedRegimen<-NA

## below nested for loops cycle through pharmacotype grid to match each pharmacotype to its nearest regimen, testing regimens in ranked order provided

## for each row of pharmacotype grid
for (i in 1:nrow(pharmacotypedCases)){
  
  # gradually expand allowable distance for match calls 
  #   (note starts at 1 not 0 which gives slight advantage to ranked list over pure distance)
  for (h in 1:10){ 
    
    # if already found a regimen match for this case, go start next case
    if (!is.na(pharmacotypedCases[i,"matchedRegimen"])){break}
    
    #check current case against each regimen (in priority order)
    for (j in 1:nrow(chemoCombinationsKey)){ 
      #compute distance from current regimen's ideal position to current pharmacotyped case
      ijDistance <- 
        dist(rbind(
          as.numeric(pharmacotypedCases[i, chemoAgentsList])-1, 
          as.numeric(chemoCombinationsKey[j, ])*(length(sensitivityLevels)-1)), 
          method = "manhattan") 
        
      #if we match, write name of regimen and stop checking more regimens
        if (ijDistance <= h) {
            pharmacotypedCases[i,"matchedRegimen"]<-rownames(chemoCombinationsKey)[[j]] 
            break
        }
      #repeat against each regimen until something matches at this radius, if not expand radius and try again
    }
  }
  #repeat for each case until grid completed - complete grid becomes [[2]]
}


#evaluate quality of matches from algorithm in same fashion as adjuvant/neoadjuvant

#count how many drugs in matched regimen
pharmacotypedCases$countOfMatchedDrugs <- 1+ nchar(pharmacotypedCases$matchedRegimen) - nchar(gsub("-","", pharmacotypedCases$matchedRegimen, fixed=TRUE ) )


#compute distance between regimen they got and their organoid pharmacotype
pharmacotypedCases$distanceToMatchedRegimen <- NA
for (j in 1:length(rownames(pharmacotypedCases))){
  if (pharmacotypedCases[j, "matchedRegimen"] %in% "Pan-resistant") next
  keyForRegimenTheyMatched <- c(
    grepl("FU", pharmacotypedCases[j,"matchedRegimen"], fixed = TRUE),
    grepl("SN38", pharmacotypedCases[j,"matchedRegimen"], fixed = TRUE),
    grepl("OX", pharmacotypedCases[j,"matchedRegimen"], fixed = TRUE),
    grepl("GEM", pharmacotypedCases[j,"matchedRegimen"], fixed = TRUE),
    grepl("PAC", pharmacotypedCases[j,"matchedRegimen"], fixed = TRUE)
    )
  
  
  pharmacotype <- pharmacotypedCases[j,c("FU", "SN38", "OX", "GEM", "PAC")]
  
  #this will zero out the distance for anything not in the regimen, so we only compare within the space of what they actually matched with, in contrast to the matching algorithm above where we compare everything in 5D every time to compute match
  pharmacotypedCases[j,"distanceToMatchedRegimen"] <- 
        as.numeric(dist(rbind(
          as.numeric(pharmacotype[keyForRegimenTheyMatched])-1, 
          as.numeric(c(2,2,2,2,2)[keyForRegimenTheyMatched])), 
          method = "manhattan"))
}


#cutoff of Well-matched to Poorly-matched - distance should be better than distance of "intermediate to everything" pharmacotype would be for that regimen
pharmacotypedCases$matchedWellMatched <- ifelse(pharmacotypedCases$distanceToMatchedRegimen < pharmacotypedCases$countOfMatchedDrugs, "Well-matched", "Poorly-matched")
pharmacotypedCases[pharmacotypedCases$matchedRegimen %in% "Pan-resistant",]$matchedWellMatched <- NA


rm(keyForRegimenTheyMatched, pharmacotype)
pharmacotypedCases$distanceToMatchedRegimen <- NULL
pharmacotypedCases$countOfMatchedDrugs <- NULL


#make table of match results into data frame and sort by frequency - this will become [[1]]
matches<-as.data.frame(table(pharmacotypedCases$matchedRegimen, useNA = "ifany" ))
colnames(matches)<-c("matchedRegimen","frequency")
matches <- matches[order(matches$frequency, decreasing=TRUE),]

#prepare parameters for heatmap visualization, starting with sort by frequency of match
matches$frequencyRank<-1:length(matches$frequency)
rowOrderMatrix<-merge(pharmacotypedCases[,c("case.ID", "matchedRegimen")], matches[,c("frequencyRank","matchedRegimen")], by =  "matchedRegimen", all = TRUE, sort = FALSE)
rowOrderMatrix<-rowOrderMatrix[sort.list(rowOrderMatrix$frequencyRank),]

## red/green colorblind non-accessible version
# colorSpaceSensitivity <- t(as.matrix(colorRampPalette(colors = c("green4", "gold1","red3"))(length(sensitivityLevels))))
# colorSpaceSensitivity<-as.vector(colorSpaceSensitivity)
# colorSpaceSensitivity<-setNames(colorSpaceSensitivity, sensitivityLevels)


## viridis colorblind friendly version
colorSpaceSensitivity <-  viridis(length(sensitivityLevels), option = "E")
colorSpaceSensitivity<-as.vector(colorSpaceSensitivity)
colorSpaceSensitivity<-setNames(colorSpaceSensitivity, sensitivityLevels)


#color palette for left heatmap annotation without quality flag
colorSpaceMatches <- t(as.matrix(colorRampPalette(colors = c("blue4", "magenta3"))(length(matches$matchedRegimen))))
colorSpaceMatches<-as.vector(colorSpaceMatches)
colorSpaceMatches<-setNames(colorSpaceMatches, matches$matchedRegimen)

#heatmap annotations - uses anno_mark to draw lines to labels, and labels first row in each chunk
# this version without quality flag annotation
left_HA <- HeatmapAnnotation(which = "row", show_legend = FALSE,
                             marks = anno_mark(at = which(!duplicated(pharmacotypedCases[,"matchedRegimen"])),
                                               side = "left",
                                               labels  =                            pharmacotypedCases[which(!duplicated(pharmacotypedCases[,"matchedRegimen"])),"matchedRegimen"]),
                             Match = pharmacotypedCases[,"matchedRegimen"],
                             col = list(Match = colorSpaceMatches)
                             )

heatmapResult <- Heatmap(as.matrix(pharmacotypedCases[,1:5]), name='Agent Sensitivity',
        col = colorSpaceSensitivity,
        left_annotation = left_HA,
        row_split = factor(pharmacotypedCases$matchedRegimen, levels = matches$matchedRegimen),
        row_order = order(rowOrderMatrix$frequencyRank),
        cluster_row_slices = FALSE,
        cluster_rows = FALSE ,
        cluster_columns = FALSE,
        show_column_names = TRUE,
        column_names_rot = 0,
        column_names_centered = TRUE,
        show_row_names = FALSE,
        row_title = NULL,
        heatmap_width = unit(12, "cm")
)

#color palette for left annotations with quality flag
colorSpaceMatches <- t(as.matrix(colorRampPalette(colors = c("blue4", "magenta3"))(2)))
colorSpaceMatches<-as.vector(colorSpaceMatches)
colorSpaceMatches<-setNames(colorSpaceMatches, c("Well-matched", "Poorly-matched"))

#heatmap annotation
# this version includes quality flag annotation
left_HA <- HeatmapAnnotation(which = "row", show_legend = FALSE,
                             marks = anno_mark(at = which(!duplicated(pharmacotypedCases[,"matchedRegimen"])),
                                               side = "left",
                                               labels  =                            pharmacotypedCases[which(!duplicated(pharmacotypedCases[,"matchedRegimen"])),"matchedRegimen"]),
                             MatchQuality = pharmacotypedCases[,"matchedWellMatched"],
                             col = list(MatchQuality = colorSpaceMatches)
                             )

heatmapResultWithQualityFlag <- Heatmap(as.matrix(pharmacotypedCases[,1:5]), name='Agent Sensitivity',
        col = colorSpaceSensitivity,
        left_annotation = left_HA,
        row_split = factor(pharmacotypedCases$matchedRegimen, levels = matches$matchedRegimen),
        row_order = order(rowOrderMatrix$frequencyRank),
        cluster_row_slices = FALSE,
        cluster_rows = FALSE ,
        cluster_columns = FALSE,
        show_column_names = TRUE,
        column_names_rot = 0,
        column_names_centered = TRUE,
        show_row_names = FALSE,
        row_title = NULL,
        heatmap_width = unit(12, "cm")
)


# algorithm will not print heatmaps until result is called directly
# now gives two options, one with flag for match quality

list(matchFrequencies = matches, matchedCases = pharmacotypedCases, allPossibleCombinations = allRegimens, heatmapFigure = heatmapResult, heatmapFigureWithQualityFlag = heatmapResultWithQualityFlag)

}

```

```{r run-match-algorithm}
# ranked vector of NCCN-recommended regimens in PDAC
# note assumes clinical regimen of gem-cis or gem-cis-abraxane could be represented by oxali in lieu of cis
NCCNRegimens <- c("FU-SN38-OX", "GEM-PAC", "FU-GEM", "FU-OX", "FU-SN38", "OX-GEM-PAC", "OX-GEM", "FU", "GEM" )

## vector of non-standard-in-pdac but allowed regimens - from NCCN guidelines for cholangio, gastric, colon:
#"FLOT" FU-OX-PAC, "paclitaxel-carboplatin" in gastric cancer could be OX-PAC, irinotecan or paclitaxel monotherapy options for gastric
alternateRegimens <- c("FU-OX-PAC", "OX-PAC", "SN38-OX", "SN38-PAC", "SN38", "PAC")


SimPharmacotypeMatchResults <- regimenMatch(pharmacotypedCases = pharmacotypedCasesSim, preferredRegimens = c(NCCNRegimens, alternateRegimens), prohibitedRegimens = c("FU-SN38-OX-GEM", "FU-SN38-OX-PAC", "FU-SN38-GEM-PAC", "FU-OX-GEM-PAC", "SN38-OX-GEM-PAC", "FU-SN38-OX-GEM-PAC"), usePermutedCombos = FALSE)

Fig2A <- SimPharmacotypeMatchResults$heatmapFigure

```


```{r session-info}

sessionInfo()


```
